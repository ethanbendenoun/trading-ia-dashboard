<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üè¶ Trading IA V3 ‚Äî Institutional Terminal</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:#030303; color:#e0e0e0; font-family:'Inter', 'Segoe UI', sans-serif; font-size: 14px; }
  
  /* Header & Status Bar */
  .header { background:#0a0a0a; padding:20px 25px; border-bottom:1px solid #1f1f1f; position: sticky; top:0; z-index:100; display: flex; justify-content: space-between; align-items: center; }
  .header-left h1 { font-size:1.4em; letter-spacing: 1.5px; text-transform: uppercase; color: #fff; margin-bottom: 5px; }
  .status-bar { font-size: 0.85em; color: #888; }
  .date { color:#00AAFF; font-weight:bold; }
  
  .container { max-width:1400px; margin:0 auto; padding:20px; }
  
  /* Market Stress Gauge V3 */
  .market-status { background: linear-gradient(90deg, #0a0a0a, #111); border-radius: 8px; padding: 15px 20px; margin-bottom: 20px; border: 1px solid #222; display: flex; align-items: center; justify-content: space-between; }
  .stress-label { font-weight: bold; font-size: 0.9em; color: #666; letter-spacing: 1px; }
  .stress-value { font-size: 1.2em; font-weight: bold; text-transform: uppercase; }

  /* Cards Grid */
  .synthese { display:grid; grid-template-columns:repeat(4,1fr); gap:15px; margin-bottom: 20px; }
  .card { background:#0a0a0a; border-radius:8px; padding:20px; text-align:center; border:1px solid #1f1f1f; }
  .card .nb { font-size:2.2em; font-weight:bold; }
  .card .label { color:#666; font-size: 0.75em; text-transform: uppercase; margin-top:8px; letter-spacing: 1px; }
  
  /* Trading Table V3 (Scrollable for 25+ tickers) */
  .table-container { background:#0a0a0a; border-radius:8px; border:1px solid #1f1f1f; margin-bottom: 20px; overflow-x: auto; max-height: 600px; overflow-y: auto; }
  .table-container h2 { padding: 15px 20px; font-size: 1em; border-bottom: 1px solid #1f1f1f; color: #fff; position: sticky; top: 0; background: #0a0a0a; z-index: 10; }
  table { width: 100%; border-collapse: collapse; }
  th { text-align: left; padding: 12px 20px; color: #555; font-size: 0.75em; border-bottom: 1px solid #222; text-transform: uppercase; letter-spacing: 1px; position: sticky; top: 50px; background: #0a0a0a; z-index: 10; }
  td { padding: 12px 20px; border-bottom: 1px solid #111; font-size: 0.9em; white-space: nowrap; }
  tr:hover td { background: #111; }
  
  /* Badges V3 */
  .badge { padding:4px 10px; border-radius:4px; font-size:0.75em; font-weight:bold; }
  .bg-achat-fort { background:#00FF8833; color:#00FF88; border:1px solid #00FF8866; }
  .bg-achat { background:#00AAFF33; color:#00AAFF; border:1px solid #00AAFF66; }
  .bg-neutre { background:#333; color:#aaa; border:1px solid #555; }
  .bg-vente { background:#FF6B3533; color:#FF6B35; border:1px solid #FF6B3566; }
  .bg-danger { background:#FF000033; color:#FF4444; border:1px solid #FF0000; animation: pulse 2s infinite; }
  @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.4); } 70% { box-shadow: 0 0 0 5px rgba(255, 0, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); } }

  /* Progress Bars */
  .risk-bar-bg { background: #1a1a1a; height: 4px; border-radius: 2px; width: 80px; display: inline-block; vertical-align: middle; }
  .risk-bar-fill { height: 4px; border-radius: 2px; }

  .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
  .chart-container { background:#0a0a0a; border-radius:8px; padding:20px; border:1px solid #1f1f1f; }
  .chart-container h2 { font-size: 1em; margin-bottom: 15px; color: #fff; }
  
  .refresh-btn { background:transparent; color:#00AAFF; border:1px solid #00AAFF; padding:8px 16px; border-radius:4px; cursor:pointer; font-weight:bold; transition: 0.2s; font-size: 0.8em; text-transform: uppercase; }
  .refresh-btn:hover { background: #00AAFF; color: #000; }

  @media(max-width:1024px) { .synthese { grid-template-columns: 1fr 1fr; } .grid-2 { grid-template-columns: 1fr; } .header { flex-direction: column; align-items: flex-start; gap: 15px; } }
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <h1>üè¶ TRADING IA ‚Äî V3 INSTITUTIONAL</h1>
    <div class="status-bar">
      Moteur: <span style="color:#fff">Ensemble Model (XGB + LSTM + Crash)</span> | 
      Univers: <span style="color:#fff">US Top 25</span> | 
      Update: <span class="date" id="date-update">...</span>
    </div>
  </div>
  <button class="refresh-btn" onclick="loadData()">Sync Data üîÑ</button>
</div>

<div class="container">
  <div class="market-status">
    <div class="stress-label">R√âGIME DE MARCH√â V3</div>
    <div id="global-stress" class="stress-value">Analyse en cours...</div>
  </div>

  <div id="content">
    <div style="text-align:center; padding:100px; color:#555;">Initialisation du Terminal V3...</div>
  </div>
</div>

<script>
// ‚ö†Ô∏è V√âRIFIE BIEN TON USERNAME GITHUB
const GITHUB_USER = 'ethanbendenoun';
const GITHUB_REPO = 'trading-ia-dashboard';
const JSON_URL    = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/rapport_latest.json`;

async function loadData() {
  try {
    const res = await fetch(JSON_URL + '?t=' + Date.now());
    const data = await res.json();
    renderDashboard(data);
  } catch(e) {
    console.error(e);
    document.getElementById('content').innerHTML = `<div style="color:#FF4444; text-align:center; padding:50px; border: 1px solid #FF4444; border-radius: 8px; background: #1a0505;">‚ùå Erreur de flux de donn√©es. V√©rifiez l'export JSON V3.</div>`;
  }
}

function getBadgeClass(signal) {
  const s = signal.toLowerCase();
  if (s.includes('achat fort')) return 'bg-achat-fort';
  if (s.includes('achat')) return 'bg-achat';
  if (s.includes('danger') || s.includes('prudence')) return 'bg-danger';
  if (s.includes('vente')) return 'bg-vente';
  return 'bg-neutre';
}

function renderDashboard(data) {
  // R√©trocompatibilit√© ou nouvelle cl√© V3
  const signaux = data.signaux || data.predictions || [];
  const resume = data.resume || data.summary || {};
  
  // Analyse globale V3
  const marketStatus = data.market_status || "NORMAL";
  const stressEl = document.getElementById('global-stress');
  stressEl.textContent = marketStatus;
  stressEl.style.color = marketStatus.includes('BEAR') || marketStatus.includes('CRISIS') ? '#FF4444' : '#00FF88';

  document.getElementById('date-update').textContent = data.heure || data.date || 'Maintenant';

  // Comptage dynamique (Adapt√© aux 25 tickers)
  const nbAchats = signaux.filter(s => s.signal.includes('ACHAT')).length;
  const nbDangers = signaux.filter(s => s.signal.includes('DANGER')).length;
  const topPick = resume.top_achat || resume.top_pick || (nbAchats > 0 ? signaux.find(s => s.signal.includes('ACHAT')).ticker : 'AUCUN');

  document.getElementById('content').innerHTML = `
    <div class="synthese">
      <div class="card" style="border-top: 2px solid #00AAFF">
        <div class="nb" style="color:#00AAFF">${signaux.length}</div>
        <div class="label">Actifs Scann√©s</div>
      </div>
      <div class="card" style="border-top: 2px solid #00FF88">
        <div class="nb" style="color:#00FF88">${nbAchats}</div>
        <div class="label">Opportunit√©s (Achats)</div>
      </div>
      <div class="card" style="border-top: 2px solid #FF0000">
        <div class="nb" style="color:#FF4444">${nbDangers}</div>
        <div class="label">Zones de Danger</div>
      </div>
      <div class="card" style="border-top: 2px solid #fff">
        <div class="nb" style="color:#fff">${topPick}</div>
        <div class="label">Top Pick V3</div>
      </div>
    </div>

    <div class="table-container">
      <h2>üìã MATRICE DE D√âCISION US TOP 25</h2>
      <table>
        <thead>
          <tr>
            <th>TICKER</th>
            <th>SIGNAL V3</th>
            <th>PROBA. HAUSSE</th>
            <th>CRASH RISK</th>
            <th>PRIX</th>
            <th>STOP LOSS</th>
            <th>SIZING</th>
          </tr>
        </thead>
        <tbody>
          ${signaux.map(s => {
            const crashRisk = s.crash_risk || 0;
            const proba = s.prob_hausse || s.p_hausse_adj || 50;
            const riskColor = crashRisk > 50 ? '#FF0000' : crashRisk > 30 ? '#FFD700' : '#00FF88';
            
            return `
              <tr>
                <td style="font-weight:bold; color:#fff;">${s.ticker}</td>
                <td><span class="badge ${getBadgeClass(s.signal)}">${s.signal}</span></td>
                <td><span style="color:${proba > 55 ? '#00FF88' : '#aaa'}">${proba.toFixed(1)}%</span></td>
                <td>
                  <div class="risk-bar-bg"><div class="risk-bar-fill" style="width:${Math.min(crashRisk, 100)}%; background:${riskColor}"></div></div>
                  <span style="font-size:0.8em; margin-left:8px; color:${riskColor}">${crashRisk.toFixed(0)}%</span>
                </td>
                <td style="color:#aaa">$${(s.prix || s.price || 0).toFixed(2)}</td>
                <td style="color:#FF4444">${s.stop_loss || s.sl ? '$' + (s.stop_loss || s.sl).toFixed(2) : '-'}</td>
                <td style="color:#00AAFF; font-weight:bold;">${s.sizing ? s.sizing.toFixed(1)+'%' : '-'}</td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    </div>

    <div class="grid-2">
      <div class="chart-container">
        <h2>üî¨ ALLOCATION DU PORTEFEUILLE (%)</h2>
        <canvas id="sizingChart"></canvas>
      </div>
      <div class="chart-container">
        <h2>üìä RISQUE DE CRASH PAR ACTIF</h2>
        <canvas id="crashChart"></canvas>
      </div>
    </div>
  `;

  // --- Graphiques avec Chart.js ---
  // On limite l'affichage aux 15 premiers pour ne pas surcharger les graphiques, 
  // le tableau s'occupe de montrer les 25.
  const topSignaux = signaux.slice(0, 15); 
  const tickers = topSignaux.map(s => s.ticker);
  
  new Chart(document.getElementById('sizingChart'), {
    type: 'bar',
    data: {
      labels: tickers,
      datasets: [{
        label: 'Sizing (%)',
        data: topSignaux.map(s => s.sizing || 0),
        backgroundColor: '#00AAFF',
        borderRadius: 4
      }]
    },
    options: { plugins:{legend:{display:false}}, scales:{ y:{grid:{color:'#1f1f1f'}}, x:{grid:{display:false}} } }
  });

  new Chart(document.getElementById('crashChart'), {
    type: 'line',
    data: {
      labels: tickers,
      datasets: [{
        label: 'Crash Risk (%)',
        data: topSignaux.map(s => s.crash_risk || 0),
        borderColor: '#FF4444',
        backgroundColor: 'rgba(255, 68, 68, 0.1)',
        fill: true,
        tension: 0.4
      }]
    },
    options: { plugins:{legend:{display:false}}, scales:{ y:{beginAtZero:true, max:100, grid:{color:'#1f1f1f'}}, x:{grid:{display:false}} } }
  });
}

loadData();
</script>
</body>
</html>
